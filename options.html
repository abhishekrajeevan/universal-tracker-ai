<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Universal Tracker AI - Options</title>
    <style>
        * { box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #2d3748;
        }
        
        .container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0;
            font-size: 28px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }
        
        .header-icon {
            width: 32px;
            height: 32px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }
        .content { padding: 40px; }
        .section { margin-bottom: 40px; padding: 30px; background: #f8fafc; border-radius: 16px; border: 1px solid #e2e8f0; }
        .section h2 { margin-top: 0; margin-bottom: 20px; color: #1e293b; font-size: 22px; display: flex; align-items: center; gap: 10px; }
        .section-icon { font-size: 18px; }
        .form-group { margin-bottom: 25px; }
        label { display: block; font-weight: 600; margin-bottom: 8px; color: #374151; font-size: 15px; }
        input[type="text"], input[type="password"], input[type="number"] { width: 100%; padding: 14px 16px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 15px; transition: all 0.2s ease; background: white; }
        input[type="text"]:focus, input[type="password"]:focus, input[type="number"]:focus { outline: none; border-color: #4f46e5; box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }
        .checkbox-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px; margin-top: 16px; }
        .checkbox-item { display: flex; align-items: center; gap: 12px; padding: 16px; background: white; border-radius: 12px; border: 2px solid #e2e8f0; transition: all 0.2s ease; cursor: pointer; }
        .checkbox-item:hover { border-color: #c7d2fe; background: #fafbff; }
        .checkbox-item input[type="checkbox"] { width: 20px; height: 20px; cursor: pointer; }
        .checkbox-item label { margin: 0; font-weight: 500; cursor: pointer; flex: 1; font-size: 15px; }
        .checkbox-item.checked { border-color: #4f46e5; background: #eef2ff; }
        .help-text { font-size: 14px; color: #64748b; margin-top: 8px; line-height: 1.5; }
        .help-text a { color: #4f46e5; text-decoration: none; font-weight: 500; }
        .help-text a:hover { text-decoration: underline; }
        .description { background: #f1f5f9; border: 1px solid #cbd5e1; border-radius: 12px; padding: 20px; margin-bottom: 20px; font-size: 14px; line-height: 1.6; color: #475569; }
        .description strong { color: #1e293b; }
        .btn { background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); color: white; border: none; padding: 14px 28px; border-radius: 12px; font-weight: 600; font-size: 15px; cursor: pointer; transition: all 0.2s ease; display: inline-flex; align-items: center; gap: 8px; margin-right: 10px; margin-bottom: 10px; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px -5px rgba(79, 70, 229, 0.4); }
        .btn:disabled { opacity: 0.7; transform: none; cursor: not-allowed; }
        .btn-secondary { background: #f1f5f9; color: #475569; border: 2px solid #e2e8f0; }
        .btn-secondary:hover { background: #e2e8f0; box-shadow: 0 4px 12px -2px rgba(0, 0, 0, 0.1); }
        .btn-success { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .btn-info { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); }
        .btn-warning { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
        .status { padding: 16px; border-radius: 12px; margin-top: 16px; font-weight: 500; display: flex; align-items: center; gap: 10px; }
        .status.success { background: #d1fae5; color: #065f46; border: 2px solid #a7f3d0; }
        .status.error { background: #fee2e2; color: #991b1b; border: 2px solid #fca5a5; }
        .status.info { background: #dbeafe; color: #1e40af; border: 2px solid #93c5fd; }
        .test-section { border: 2px dashed #c7d2fe; background: #fafbff; padding: 30px; border-radius: 16px; text-align: center; }
        .test-section h3 { margin-top: 0; color: #4338ca; font-size: 20px; }
        .test-result { text-align: left; margin-top: 16px; padding: 16px; background: white; border-radius: 8px; border: 1px solid #e2e8f0; }
        .test-result strong { color: #1e293b; }
        .test-result small { display: block; margin-top: 8px; line-height: 1.6; }
        .actions { display: flex; gap: 16px; margin-top: 30px; flex-wrap: wrap; }
        .feature-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 20px; }
        .feature-card { background: white; padding: 20px; border-radius: 12px; border: 1px solid #e2e8f0; }
        .feature-card h4 { margin-top: 0; color: #1e293b; font-size: 16px; }
        .feature-card p { margin: 0; color: #64748b; font-size: 14px; line-height: 1.5; }
        .button-group { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>
                <div class="header-icon">⚙️</div>
                Universal Tracker AI Configuration
            </h1>
        </div>
        
        <div class="content">
            <div class="section">
                <h2><span class="section-icon">📊</span> Google Sheets Integration</h2>
                <div class="description">
                    <strong>🚀 First time setup?</strong> Follow the <a href="#" id="setupGuideLink">complete setup guide</a> to connect your Google Sheets.
                    <br><br>
                    <strong>Already set up?</strong> Paste your <strong>Apps Script Web App Base URL</strong> below. The enhanced system includes:
                    <br><br>
                    • <strong>Automatic archiving</strong> - Old items are moved to separate sheets to keep active data fast
                    <br>
                    • <strong>Batch processing</strong> - Improved performance with larger batch sizes
                    <br>
                    • <strong>Multiple sheets</strong> - Organized storage with monthly archives
                    <br>
                    • <strong>Statistics tracking</strong> - Monitor your storage usage and item counts
                </div>
                
                <div class="form-group">
                    <label for="appsScriptUrl">🔗 Apps Script Base URL</label>
                    <input type="text" id="appsScriptUrl" placeholder="https://script.google.com/macros/s/AKfycbx.../exec" />
                    <div class="help-text">Get this URL from your Google Apps Script deployment settings</div>
                </div>

                <div class="form-group">
                    <label for="autosync">⏰ Auto-sync interval (minutes)</label>
                    <input type="number" id="autosync" value="10" min="5" step="1" />
                    <div class="help-text">How often to automatically sync your tracked items (minimum 5 minutes)</div>
                </div>
                
                <div class="button-group">
                    <button class="btn btn-success" id="testConnectionBtn">
                        <span>🔗</span> Test Connection
                    </button>
                    <button class="btn btn-info" id="viewStatsBtn">
                        <span>📊</span> View Statistics
                    </button>
                    <button class="btn btn-warning" id="triggerArchiveBtn">
                        <span>📦</span> Archive Now
                    </button>
                </div>
            </div>
            <div class="section">
                <h2><span class="section-icon">🤖</span> AI Configuration</h2>
                <div class="form-group">
                    <label for="apiKey">Google Gemini API Key</label>
                    <input type="password" id="apiKey" placeholder="Enter your Gemini API key">
                    <div class="help-text">
                        Get your free API key from <a href="https://makersuite.google.com/app/apikey" target="_blank">Google AI Studio</a>. 
                        The API includes a generous free tier with 15 requests per minute.
                    </div>
                </div>
            </div>

            <div class="section">
                <h2><span class="section-icon">⚙️</span> AI Prefill Options</h2>
                <p style="margin-bottom: 20px; color: #64748b;">Choose which fields should be automatically filled by AI when saving new items:</p>
                
                <div class="checkbox-grid">
                    <div class="checkbox-item" onclick="toggleCheckbox('prefillTitle')">
                        <input type="checkbox" id="prefillTitle">
                        <label for="prefillTitle">📝 Auto-fill Title</label>
                    </div>
                    <div class="checkbox-item" onclick="toggleCheckbox('prefillCategory')">
                        <input type="checkbox" id="prefillCategory">
                        <label for="prefillCategory">📂 Auto-select Category</label>
                    </div>
                    <div class="checkbox-item" onclick="toggleCheckbox('prefillPriority')">
                        <input type="checkbox" id="prefillPriority">
                        <label for="prefillPriority">⭐ Auto-set Priority</label>
                    </div>
                    <div class="checkbox-item" onclick="toggleCheckbox('prefillTags')">
                        <input type="checkbox" id="prefillTags">
                        <label for="prefillTags">🏷️ Auto-generate Tags</label>
                    </div>
                    <div class="checkbox-item" onclick="toggleCheckbox('prefillSummary')">
                        <input type="checkbox" id="prefillSummary">
                        <label for="prefillSummary">📋 Auto-write Summary</label>
                    </div>
                </div>
            </div>
            <div class="section">
                <h2><span class="section-icon">ℹ️</span> How AI Prefill Works</h2>
                <div class="feature-grid">
                    <div class="feature-card">
                        <h4>📝 Smart Title Cleaning</h4>
                        <p>Removes platform suffixes, episode numbers, and cleans up page titles for better readability.</p>
                    </div>
                    <div class="feature-card">
                        <h4>📂 Category Detection</h4>
                        <p>Analyzes content and URL to automatically categorize items as Movie, TV, Video, Blog, etc.</p>
                    </div>
                    <div class="feature-card">
                        <h4>⭐ Priority Assessment</h4>
                        <p>Determines urgency based on keywords like "trending", "new release", or "deadline".</p>
                    </div>
                    <div class="feature-card">
                        <h4>🏷️ Contextual Tags</h4>
                        <p>Generates relevant tags based on content, platform, and genre detection.</p>
                    </div>
                    <div class="feature-card">
                        <h4>📋 Summary Generation</h4>
                        <p>Creates concise, informative summaries from page descriptions and content.</p>
                    </div>
                    <div class="feature-card">
                        <h4>🔄 Fallback System</h4>
                        <p>If AI fails, rule-based suggestions ensure you still get intelligent recommendations.</p>
                    </div>
                </div>
            </div>

            <div class="test-section">
                <h3>🧪 Test AI Configuration</h3>
                <p>Test your AI setup with a sample webpage to ensure everything works correctly:</p>
                <button class="btn" id="testAIBtn">
                    <span>🚀</span> Test AI Suggestions
                </button>
                <div id="testAIStatus"></div>
            </div>

            <div class="actions">
                <button class="btn" id="saveBtn">
                    <span>💾</span> Save All Settings
                </button>
                <button class="btn btn-secondary" id="resetBtn">
                    <span>🔄</span> Reset to Defaults
                </button>
            </div>
            
            <div id="saveStatus"></div>
        </div>
    </div>
    <script>
        const OPTS_KEY = "options";
        const AI_OPTS_KEY = "ai_options";
        
        async function getLocal(key){ return (await chrome.storage.local.get([key]))[key]; }
        async function setLocal(key,val){ return chrome.storage.local.set({[key]:val}); }

        let currentConfig = {};
        let currentAIConfig = {};

        function toggleCheckbox(id) {
            const checkbox = document.getElementById(id);
            checkbox.checked = !checkbox.checked;
            updateCheckboxUI();
        }

        function updateCheckboxUI() {
            document.querySelectorAll('.checkbox-item').forEach(item => {
                const checkbox = item.querySelector('input[type="checkbox"]');
                if (checkbox.checked) { item.classList.add('checked'); }
                else { item.classList.remove('checked'); }
            });
        }

        async function loadConfig() {
            try {
                const opts = (await getLocal(OPTS_KEY)) || {};
                currentConfig = opts;
                document.getElementById('appsScriptUrl').value = opts.apps_script_url || "";
                document.getElementById('autosync').value = opts.autosync_mins || 10;
                const aiResult = await chrome.storage.local.get([AI_OPTS_KEY]);
                currentAIConfig = aiResult[AI_OPTS_KEY] || {};
                document.getElementById('apiKey').value = currentAIConfig.api_key || '';
                document.getElementById('prefillTitle').checked = currentAIConfig.prefill_title || false;
                document.getElementById('prefillCategory').checked = currentAIConfig.prefill_category || false;
                document.getElementById('prefillPriority').checked = currentAIConfig.prefill_priority || false;
                document.getElementById('prefillTags').checked = currentAIConfig.prefill_tags || false;
                document.getElementById('prefillSummary').checked = currentAIConfig.prefill_summary || false;
                updateCheckboxUI();
            } catch (error) {
                console.error('Failed to load config:', error);
                showStatus('saveStatus', 'error', 'Failed to load configuration: ' + error.message);
            }
        }

        async function saveAllConfig() {
            const saveBtn = document.getElementById('saveBtn');
            const originalText = saveBtn.innerHTML;
            saveBtn.innerHTML = '<span>⏳</span> Saving...';
            saveBtn.disabled = true;
            try {
                const url = document.getElementById('appsScriptUrl').value.trim();
                const mins = Number(document.getElementById('autosync').value);
                if (url && !url.startsWith('https://script.google.com/')) {
                    throw new Error('Please enter a valid Google Apps Script URL');
                }
                const opts = currentConfig;
                opts.apps_script_url = url;
                opts.autosync_mins = Math.max(5, mins || 10);
                await setLocal(OPTS_KEY, opts);
                const aiConfig = {
                    api_key: document.getElementById('apiKey').value.trim(),
                    prefill_title: document.getElementById('prefillTitle').checked,
                    prefill_category: document.getElementById('prefillCategory').checked,
                    prefill_priority: document.getElementById('prefillPriority').checked,
                    prefill_tags: document.getElementById('prefillTags').checked,
                    prefill_summary: document.getElementById('prefillSummary').checked
                };
                await chrome.storage.local.set({ [AI_OPTS_KEY]: aiConfig });
                currentConfig = opts;
                currentAIConfig = aiConfig;
                chrome.alarms.create("autosync", { periodInMinutes: opts.autosync_mins });
                showStatus('saveStatus', 'success', '✅ All settings saved successfully!');
            } catch (error) {
                showStatus('saveStatus', 'error', '❌ Failed to save: ' + error.message);
            } finally {
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
            }
        }

        async function resetConfig() {
            if (!confirm('Are you sure you want to reset all settings to defaults?')) { return; }
            const resetBtn = document.getElementById('resetBtn');
            const originalText = resetBtn.innerHTML;
            resetBtn.innerHTML = '<span>🔄</span> Resetting...';
            resetBtn.disabled = true;
            try {
                const defaultConfig = { apps_script_url: '', autosync_mins: 10 };
                const defaultAIConfig = { api_key: '', prefill_title: true, prefill_category: true, prefill_priority: true, prefill_tags: true, prefill_summary: true };
                await setLocal(OPTS_KEY, defaultConfig);
                await chrome.storage.local.set({ [AI_OPTS_KEY]: defaultAIConfig });
                location.reload();
            } catch (error) {
                showStatus('saveStatus', 'error', '❌ Failed to reset: ' + error.message);
            } finally {
                resetBtn.innerHTML = originalText;
                resetBtn.disabled = false;
            }
        }

        async function testConnection() {
            const btn = document.getElementById('testConnectionBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span>⏳</span> Testing...';
            btn.disabled = true;
            try {
                const url = document.getElementById('appsScriptUrl').value.trim();
                if (!url) { throw new Error('Please enter an Apps Script URL first'); }
                if (!url.startsWith('https://script.google.com/')) { throw new Error('URL must start with https://script.google.com/'); }
                if (!url.endsWith('/exec')) { throw new Error('URL must end with /exec'); }
                const response = await fetch(url + "?action=getStats", { method: "GET", headers: { 'Content-Type': 'application/json' } });
                if (!response.ok) {
                    if (response.status === 403) throw new Error('Access denied. Make sure your Apps Script is deployed with "Anyone" access.');
                    else if (response.status === 404) throw new Error('Not found. Check that your Apps Script is deployed as a Web App.');
                    else throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                const result = await response.json();
                const message = `✅ Connection successful!\n\n` +
                      `📊 Current Statistics:\n` +
                      `• Active Items: ${result.active}\n` +
                      `• Archived Items: ${result.archived}\n` +
                      `• Total Items: ${result.total}\n` +
                      `• Archive Sheets: ${result.archiveSheets}\n\n` +
                      `🎉 Your Universal Tracker is ready to use!`;
                alert(message);
                btn.innerHTML = '<span>✅</span> Connected';
                setTimeout(() => { btn.innerHTML = originalText; btn.disabled = false; }, 2000);
            } catch (error) {
                alert(`❌ Connection failed: ${error.message}`);
                btn.innerHTML = '<span>❌</span> Failed';
                setTimeout(() => { btn.innerHTML = originalText; btn.disabled = false; }, 2000);
            }
        }

        async function viewStats() {
            const btn = document.getElementById('viewStatsBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span>⏳</span> Loading...';
            btn.disabled = true;
            try {
                const response = await chrome.runtime.sendMessage({ type: 'GET_STATS' });
                if (response && response.success) {
                    const stats = response.stats;
                    alert(`📊 Storage Statistics:\n\n` +
                          `Active Items: ${stats.active}\n` +
                          `Archived Items: ${stats.archived}\n` +
                          `Total Items: ${stats.total}\n` +
                          `Archive Sheets: ${stats.archiveSheets}\n\n` +
                          `💡 Tip: Items older than 6 months are automatically archived to keep your active sheet fast.`);
                } else {
                    throw new Error((response && response.error) || 'Failed to get stats');
                }
            } catch (error) {
                alert(`Error getting statistics: ${error.message}`);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        async function triggerArchive() {
            const btn = document.getElementById('triggerArchiveBtn');
            const originalText = btn.innerHTML;
            if (!confirm('This will archive items older than 6 months to separate sheets. Continue?')) { return; }
            btn.innerHTML = '<span>⏳</span> Archiving...';
            btn.disabled = true;
            try {
                const response = await chrome.runtime.sendMessage({ type: 'TRIGGER_ARCHIVE' });
                if (response && response.success) { alert(`✅ Archive completed!\n\n${response.message}`); btn.innerHTML = '<span>✅</span> Archived'; }
                else { throw new Error((response && response.error) || 'Archive failed'); }
            } catch (error) {
                alert(`❌ Archive failed: ${error.message}`);
                btn.innerHTML = '<span>❌</span> Failed';
            } finally {
                setTimeout(() => { btn.innerHTML = originalText; btn.disabled = false; }, 2000);
            }
        }

        async function testAI() {
            const testBtn = document.getElementById('testAIBtn');
            const statusDiv = document.getElementById('testAIStatus');
            const originalText = testBtn.innerHTML;
            testBtn.innerHTML = '<span>⏳</span> Testing...';
            testBtn.disabled = true;
            statusDiv.innerHTML = '';
            try {
                const aiConfig = {
                    api_key: document.getElementById('apiKey').value.trim(),
                    prefill_title: document.getElementById('prefillTitle').checked,
                    prefill_category: document.getElementById('prefillCategory').checked,
                    prefill_priority: document.getElementById('prefillPriority').checked,
                    prefill_tags: document.getElementById('prefillTags').checked,
                    prefill_summary: document.getElementById('prefillSummary').checked
                };
                await chrome.storage.local.set({ [AI_OPTS_KEY]: aiConfig });
                const response = await new Promise((resolve, reject) => {
                    const timeout = setTimeout(() => { reject(new Error('Test request timed out after 15 seconds')); }, 15000);
                    chrome.runtime.sendMessage({ type: 'TEST_AI' }, (response) => {
                        clearTimeout(timeout);
                        if (chrome.runtime.lastError) { reject(new Error(chrome.runtime.lastError.message)); }
                        else { resolve(response); }
                    });
                });
                if (response && response.success && response.suggestions) {
                    const suggestions = response.suggestions;
                    const tags = suggestions.tags ? suggestions.tags.join(', ') : 'None';
                    const summary = suggestions.summary ? (suggestions.summary.length > 120 ? suggestions.summary.substring(0, 120) + '...' : suggestions.summary) : 'None';
                    statusDiv.innerHTML = `
                        <div class="status success">
                            <span>✅</span>
                            <div>
                                <strong>AI Test Successful!</strong>
                                <div class="test-result">
                                    <strong>Sample Results:</strong>
                                    <small>
                                        <strong>Title:</strong> "${suggestions.title}"<br>
                                        <strong>Category:</strong> ${suggestions.category}<br>
                                        <strong>Priority:</strong> ${suggestions.priority}<br>
                                        <strong>Tags:</strong> ${tags}<br>
                                        <strong>Summary:</strong> "${summary}"
                                    </small>
                                </div>
                            </div>
                        </div>`;
                } else {
                    throw new Error(response?.error || 'Test failed - invalid response from AI service');
                }
            } catch (error) {
                let helpText = '';
                if (error.message.includes('Missing API key') || error.message.includes('No API key')) helpText = 'Please enter a valid Gemini API key above and save the configuration.';
                else if (error.message.includes('HTTP 400')) helpText = 'Invalid API key. Please check your Gemini API key.';
                else if (error.message.includes('HTTP 403')) helpText = 'API key access denied. Please check your Gemini API key permissions.';
                else if (error.message.includes('timeout')) helpText = 'Request timed out. Please check your internet connection and try again.';
                else if (error.message.includes('No API key configured')) helpText = 'Please enter your Gemini API key above and save the configuration first.';
                statusDiv.innerHTML = `<div class="status error"><span>❌</span><div><strong>AI Test Failed</strong><div style="margin-top: 8px;">${error.message}</div>${helpText ? `<div class="help-text" style=\"margin-top: 12px;\">${helpText}</div>` : ''}</div></div>`;
            } finally {
                testBtn.innerHTML = originalText;
                testBtn.disabled = false;
            }
        }

        function showStatus(elementId, type, message) {
            const statusDiv = document.getElementById(elementId);
            const icon = type === 'success' ? '✅' : type === 'error' ? '❌' : 'ℹ️';
            statusDiv.innerHTML = `<div class="status ${type}"><span>${icon}</span> ${message}</div>`;
            if (type === 'success') { setTimeout(() => { statusDiv.innerHTML = ''; }, 5000); }
        }

        document.getElementById('saveBtn').addEventListener('click', saveAllConfig);
        document.getElementById('resetBtn').addEventListener('click', resetConfig);
        document.getElementById('testAIBtn').addEventListener('click', testAI);
        document.getElementById('testConnectionBtn').addEventListener('click', testConnection);
        document.getElementById('viewStatsBtn').addEventListener('click', viewStats);
        document.getElementById('triggerArchiveBtn').addEventListener('click', triggerArchive);

        document.querySelectorAll('.checkbox-item input[type="checkbox"]').forEach(checkbox => {
            checkbox.addEventListener('click', (e) => { e.stopPropagation(); setTimeout(updateCheckboxUI, 10); });
        });

        document.addEventListener('DOMContentLoaded', loadConfig);
    </script>
</body>
</html>
